<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Doylu ‚Äî Compare les meilleurs pass</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand" id="brandBtn" role="button" tabindex="0" aria-label="Aller √† l'accueil">
        <div class="mark">D</div><div class="brand-name">Doylu</div>
      </div>

      <nav class="desktop" aria-label="Menu">
        <a href="#home" id="nav_home">Accueil</a>
        <a href="#promos" id="nav_promos">Promos</a>
        <a href="#guide" id="nav_guide">Guide USSD</a>
        <a href="#contact" id="nav_contact">Contact</a>
      </nav>

      <button class="hamburger" id="hamburgerBtn" aria-label="Ouvrir le menu">‚ò∞</button>
    </div>

    <div class="mobile-menu hidden" id="mobileMenu">
      <a href="#home" id="mnav_home">Accueil</a>
      <a href="#promos" id="mnav_promos">Promos</a>
      <a href="#guide" id="mnav_guide">Guide USSD</a>
      <a href="#contact" id="mnav_contact">Contact</a>
    </div>
  </header>

  <!-- HOME -->
  <main id="page_home">
    <div class="container">
      <section class="hero">
        <h1>Avant d‚Äôacheter ton pass, v√©rifie ici.</h1>
        <p>Compare les offres selon ton budget. <span class="muted-inline">Donn√©es v√©rifi√©es, pr√™tes √† copier.</span></p>
      </section>

      <div class="box">
        <div class="form-title">üí∞ Ton budget (FCFA)</div>

        <div class="budget-row">
          <input id="budgetInput" inputmode="numeric" type="number" min="0" placeholder="Ex: 1500" />
          <button class="btn cta" id="findBtn" type="button">Voir les offres</button>
        </div>

        <div class="budget-grid" id="budgetGrid"></div>

        <div class="subhint">
          <div class="trust-line">
            <span class="trust-pill">üîí V√©rifi√©es SMS/USSD</span>
            <span class="trust-pill">‚öñÔ∏è Site ind√©pendant</span>
            <span class="trust-pill">Derni√®re MAJ: <strong id="lastUpdate">‚Äî</strong></span>
          </div>
          <a class="link" href="#" id="howVerifyLink">Comment on v√©rifie ?</a>
        </div>
      </div>

      <div class="controls">
        <div class="control-left">
          <span class="chip small">üéØ Ton besoin</span>
          <button class="chip active" type="button" data-u="data">üì± Data</button>
          <button class="chip" type="button" data-u="mixte">üîÑ Mixte</button>
          <button class="chip" type="button" data-u="appels">üìû Appels</button>
        </div>
        <div class="control-right">
          <button class="chip wa-chip" id="waOptIn" type="button">
            üü¢ <strong>Recevoir les bons plans sur WhatsApp</strong>
            <span class="meta">Gratuit. 1 message/jour max.</span>
          </button>
        </div>
      </div>

      <div class="controls" style="margin-top:8px">
        <div class="control-left">
          <span class="chip small">‚è± Validit√©</span>
          <button class="chip active" type="button" data-v="any">Toutes</button>
          <button class="chip" type="button" data-v="1">24h</button>
          <button class="chip" type="button" data-v="7">7 jours</button>
          <button class="chip" type="button" data-v="30">30 jours</button>
        </div>
      </div>

      <div class="loader-wrap">
        <div class="loader" id="loader" aria-live="polite">
          <span class="spinner" aria-hidden="true"></span>
          <span id="loaderText">Recherche en cours‚Ä¶</span>
        </div>
      </div>

      <div class="best" id="bestPick" style="display:none"></div>
      <div class="results" id="results"></div>

      <div class="habit" id="habitMsg" style="display:none">
        <div class="section-card">
          Beaucoup prennent le m√™me forfait par <strong>habitude</strong>. V√©rifie toujours avant d‚Äôacheter.
        </div>
      </div>

      <div class="section" id="popularSection" style="display:none">
        <div class="section-title">üî• Les plus choisis ce mois-ci</div>
        <div class="section-card">
          <div id="popularList" class="section-sub"></div>
        </div>
      </div>

      <footer>¬© 2026 Doylu ‚Ä¢ Site ind√©pendant des op√©rateurs.</footer>
    </div>
  </main>

  <!-- PROMOS -->
  <main id="page_promos" class="hidden-page">
    <div class="container">
      <section class="hero">
        <h1>Promos du moment (v√©rifi√©es)</h1>
        <p>Mis √† jour r√©guli√®rement. Codes USSD pr√™ts √† copier.</p>
      </section>

      <div class="results" id="promoResults"></div>

      <div class="section" style="margin-top:10px">
        <div class="section-card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div>
              <div class="bold">Confiance</div>
              <div class="section-sub">On publie des offres re√ßues par SMS/USSD et confirm√©es. Si une promo expire, elle est retir√©e.</div>
            </div>
            <button class="btn gray" type="button" id="howVerifyBtn2">Comment on v√©rifie ?</button>
          </div>
        </div>
      </div>

      <footer>¬© 2026 Doylu ‚Ä¢ Site ind√©pendant des op√©rateurs.</footer>
    </div>
  </main>

  <!-- GUIDE -->
  <main id="page_guide" class="hidden-page">
    <div class="container">
      <section class="hero">
        <h1>Tous les codes USSD utiles (S√©n√©gal)</h1>
        <p>Pour acheter un pass, v√©rifier ton solde, consulter tes bonus, etc.</p>
      </section>

      <div class="box" style="max-width:920px">
        <div class="bold mb8">Par op√©rateur <span class="muted-inline">(peut varier selon offre)</span></div>

        <div class="accordion">
          <div class="acc-head">Orange <span>‚ñæ</span></div>
          <div class="acc-body">
            <div class="acc-row"><strong>Catalogue Pass</strong><span>#1234# (offline)</span></div>
            <div class="acc-row"><strong>Solde cr√©dit</strong><span>*123# (exemple)</span></div>
          </div>

          <div class="acc-head">Free <span>‚ñæ</span></div>
          <div class="acc-body">
            <div class="acc-row"><strong>Solde cr√©dit</strong><span>*xxx#</span></div>
          </div>

          <div class="acc-head">Expresso <span>‚ñæ</span></div>
          <div class="acc-body">
            <div class="acc-row"><strong>Solde cr√©dit</strong><span>*xxx#</span></div>
          </div>
        </div>

        <div class="mt14">
          <button class="btn cta" type="button" id="backHomeBtn">üîé Retour accueil</button>
        </div>
      </div>

      <footer>¬© 2026 Doylu ‚Ä¢ Site ind√©pendant des op√©rateurs.</footer>
    </div>
  </main>

  <!-- CONTACT -->
  <main id="page_contact" class="hidden-page">
    <div class="container">
      <section class="hero">
        <h1>Nous contacter</h1>
        <p>Une promo qui ne marche pas ? Une erreur ? Une id√©e ?</p>
      </section>

      <div class="box" style="max-width:920px">
        <div class="row">
          <button class="btn cta" type="button" id="reportBtn">Signaler une offre</button>
          <button class="btn cta" type="button" id="sendPromoBtn">Envoyer une promo re√ßue par SMS</button>
          <button class="btn whatsapp" type="button" id="waSupportBtn">üü¢ WhatsApp Business</button>
        </div>

        <div class="muted mt12">
          Doylu est ind√©pendant des op√©rateurs. Les offres sont informatives et v√©rifi√©es.
        </div>
      </div>

      <footer>¬© 2026 Doylu ‚Ä¢ Site ind√©pendant des op√©rateurs.</footer>
    </div>
  </main>

  <!-- UI helpers -->
  <div class="toast" id="toast">Code copi√© ‚úÖ</div>

  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Info</h3>
      <div id="modalBody"></div>
      <button class="close" type="button" id="modalCloseBtn">OK</button>
    </div>
  </div>

  <!-- ADMIN (invisible au public) -->
  <div id="adminPanel" aria-hidden="true">
    <div class="admin-topbar">
      <h3>üîê Admin (invisible au public)</h3>
      <div class="admin-note">Acc√®s via <strong>ton-site/#admin</strong> + mot de passe.</div>

      <div class="hr"></div>

      <button class="btn cta admin-btn" type="button" id="adminAddOfferBtn">‚ûï Ajouter une offre</button>
      <button class="btn cta admin-btn" type="button" id="adminAddSourceBtn">‚ûï Ajouter une source</button>
      <button class="btn cta admin-btn" type="button" id="adminRecomputeBtn">üîÅ Recalculer</button>

      <div class="hr"></div>

      <button class="btn gray admin-btn" type="button" id="adminExportBtn">‚¨áÔ∏è Export JSON</button>
      <button class="btn gray admin-btn" type="button" id="adminImportBtn">‚¨ÜÔ∏è Import JSON (fichier)</button>
      <button class="btn gray admin-btn" type="button" id="adminPasteBtn">üìã Coller JSON</button>

      <input type="file" id="adminImportFile" accept="application/json" class="hidden" />
    </div>

    <div id="adminList"></div>
  </div>

  <script src="./script.js" defer></script>
</body>
</html>


<!-- =========================
FILE: style.css
========================= -->
<style>
:root{
  --bg:#f6efe6; --card:#ffffff; --text:#111827; --muted:#6b7280;
  --cta:#f59e0b; --cta2:#fbbf24;
  --verified:#16a34a; --sponsor:#f97316; --official:#0ea5e9; --neutral:#64748b;
  --danger:#dc2626; --wa:#16a34a;
  --shadow:0 18px 45px rgba(0,0,0,.10); --soft:0 10px 25px rgba(0,0,0,.08);
  --r-xl:24px;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text)}
a{color:inherit}
.hidden{display:none !important}
.hidden-page{display:none !important}
.bold{font-weight:950}.mb8{margin-bottom:8px}.mt12{margin-top:12px}.mt14{margin-top:14px}
.muted{color:var(--muted);font-weight:900;line-height:1.5}
.muted-inline{color:var(--muted);font-weight:900}

header{position:sticky;top:0;z-index:50;background:rgba(246,239,230,.92);backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid rgba(17,24,39,.06)}
.header-inner{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;gap:12px;max-width:1120px;margin:0 auto}
.brand{display:flex;align-items:center;gap:10px;font-weight:950;font-size:20px;cursor:pointer}
.brand .mark{width:34px;height:34px;border-radius:12px;background:linear-gradient(135deg,#111827,#334155);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:950}
.brand-name{letter-spacing:.2px}

nav.desktop{display:flex;gap:18px;align-items:center}
nav.desktop a{text-decoration:none;font-weight:900;opacity:.9}
nav.desktop a:hover{opacity:1}
nav.desktop a.active{text-decoration:underline;text-underline-offset:6px}
.hamburger{display:none;border:1px solid rgba(17,24,39,.12);background:#fff;padding:10px 12px;border-radius:12px;font-weight:950;cursor:pointer}
.mobile-menu{display:none;padding:10px 18px 14px;max-width:1120px;margin:0 auto}
.mobile-menu a{display:block;padding:12px;border-radius:14px;text-decoration:none;font-weight:900;background:#fff;border:1px solid #e5e7eb;margin-top:10px}
.mobile-menu a.active{outline:2px solid #111827;outline-offset:2px}
@media (max-width:820px){nav.desktop{display:none}.hamburger{display:inline-flex}.mobile-menu{display:block}.mobile-menu.hidden{display:none !important}}

.container{max-width:1120px;margin:0 auto;padding:12px 18px 0}
.hero{text-align:center;padding:6px 0 0}
.hero h1{font-size:30px;line-height:1.12;margin:10px 0 6px}
.hero p{margin:0 auto;max-width:820px;color:var(--muted);font-size:15px}
@media (max-width:780px){.hero h1{font-size:26px}}

.box{max-width:920px;margin:14px auto 10px;background:var(--card);padding:16px;border-radius:var(--r-xl);box-shadow:var(--shadow)}
.form-title{display:flex;align-items:center;justify-content:center;gap:10px;font-weight:950;margin:2px 0 10px}

.budget-row{display:flex;gap:10px;align-items:center}
.budget-row input{
  flex:1;padding:14px 14px;border-radius:16px;border:1px solid #e5e7eb;
  font-weight:950;font-size:16px;outline:none
}
.budget-row input:focus{border-color:#111827}
.btn{width:100%;padding:14px 12px;border-radius:16px;border:none;cursor:pointer;font-weight:950;font-size:15px;display:inline-flex;align-items:center;justify-content:center;gap:10px}
.btn:active{transform:scale(.99)}
.btn.cta{background:linear-gradient(90deg,var(--cta2),var(--cta));color:#111827}
.btn.gray{background:#e5e7eb;color:#111827}
.btn.whatsapp{background:var(--wa);color:#fff}

.budget-grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px;margin-top:10px}
@media (max-width:780px){.budget-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
.budget-btn{
  padding:12px 10px;border-radius:16px;border:1px solid #e5e7eb;background:#f3f4f6;
  font-weight:950;font-size:14px;cursor:pointer;user-select:none;box-shadow:0 10px 20px rgba(0,0,0,.05);
}
.budget-btn.active{
  background:linear-gradient(90deg,var(--cta2),var(--cta));
  border-color:transparent;
  box-shadow:0 14px 24px rgba(245,158,11,.22)
}

.subhint{margin-top:10px;color:var(--muted);font-weight:900;font-size:12px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
.trust-line{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}
.trust-pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:999px;font-weight:950;color:#111827;font-size:12px}
.link{color:#2563eb;text-decoration:none;font-weight:950}
.link:hover{text-decoration:underline}

.controls{max-width:1100px;margin:10px auto 0;padding:0 18px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
.control-left,.control-right{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.chip{
  display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;background:#fff;border:1px solid #e5e7eb;
  box-shadow:0 8px 18px rgba(0,0,0,.05);font-weight:950;font-size:12px;cursor:pointer;user-select:none
}
.chip.small{font-weight:850;cursor:default}
.chip.active{background:#111827;color:#fff;border-color:transparent;box-shadow:0 12px 22px rgba(17,24,39,.14)}
.wa-chip{
  background:linear-gradient(180deg,#dcfce7,#fff);
  border:1px solid #bbf7d0;color:#064e3b;box-shadow:0 12px 24px rgba(22,163,74,.12);
  padding:12px 14px
}
.wa-chip strong{color:#064e3b}
.wa-chip .meta{display:block;font-size:11px;font-weight:900;opacity:.9}

.loader-wrap{max-width:1100px;margin:8px auto 0;padding:0 18px}
.loader{display:none;align-items:center;gap:10px;font-weight:950;color:#111827;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:12px 14px;box-shadow:0 10px 22px rgba(0,0,0,.05)}
.spinner{width:16px;height:16px;border-radius:50%;border:3px solid rgba(17,24,39,.18);border-top-color:rgba(17,24,39,.85);animation:spin .85s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.best{max-width:1100px;margin:10px auto 0;padding:0 18px}
.best .best-card{
  background:linear-gradient(180deg,#fff7ed,#ffffff);
  border:1px solid #fde68a;border-radius:18px;padding:14px;
  box-shadow:0 10px 22px rgba(0,0,0,.06);
}
.best .best-title{font-weight:950;font-size:14px}
.best .best-sub{margin-top:4px;color:var(--muted);font-weight:900;font-size:12px}

.results{max-width:1100px;margin:10px auto 0;padding:0 18px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
@media (max-width:780px){.results{grid-template-columns:1fr}}

.offer-card{background:var(--card);border-radius:20px;padding:14px;box-shadow:var(--soft);border:1px solid #eef2f7}
.top-row{display:flex;align-items:center;justify-content:space-between;gap:10px}
.operator{display:flex;align-items:center;gap:10px}
.op-logo{width:34px;height:34px;border-radius:12px;background:#f3f4f6;border:1px solid #e5e7eb;display:flex;align-items:center;justify-content:center;font-weight:950}
.offer-title{font-weight:950;font-size:15px;margin:8px 0 6px}
.price{font-size:28px;font-weight:950;color:var(--danger);margin:2px 0 6px}
.meta-line{display:flex;flex-wrap:wrap;gap:10px;color:var(--muted);font-weight:950;font-size:13px;margin-bottom:10px}

.badge{border-radius:999px;padding:7px 11px;font-size:12px;font-weight:950;color:#fff}
.badge.verified{background:var(--verified)}
.badge.sponsor{background:var(--sponsor)}
.badge.official{background:var(--official)}
.badge.neutral{background:var(--neutral)}

.ussd-box{margin-top:10px;background:linear-gradient(180deg,#fff7ed,#ffedd5);border:1px solid #fde68a;border-radius:16px;padding:12px;text-align:center;font-weight:950;font-size:18px;display:none;user-select:all}
.row-actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.row-actions .btn{flex:1;min-width:160px}

.section{max-width:1100px;margin:10px auto 0;padding:0 18px}
.section-title{font-weight:950;font-size:16px;margin:10px 0 10px}
.section-card{background:#fff;border:1px solid #e5e7eb;border-radius:18px;padding:14px;box-shadow:0 10px 22px rgba(0,0,0,.05)}
.section-sub{color:var(--muted);font-weight:900;font-size:12px;margin-top:4px}

.habit{max-width:920px;margin:10px auto 18px;padding:0 18px}
.habit .section-card{background:linear-gradient(180deg,#fff,#fff7ed);border-color:#fde68a}
.habit strong{color:#92400e}

.toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111827;color:#fff;font-weight:950;padding:12px 14px;border-radius:999px;box-shadow:var(--shadow);display:none;z-index:2000}
.modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;z-index:999}
.modal{width:min(720px, calc(100vw - 28px));background:#fff;border-radius:22px;box-shadow:var(--shadow);padding:18px}
.modal .close{width:100%;border:none;padding:14px;border-radius:16px;font-weight:950;background:#111827;color:#fff}

.accordion{background:#fff;border:1px solid #e5e7eb;border-radius:18px;overflow:hidden;box-shadow:0 10px 22px rgba(0,0,0,.05)}
.acc-head{padding:14px 16px;font-weight:950;cursor:pointer;display:flex;justify-content:space-between;border-top:1px solid #f1f5f9}
.acc-head:first-child{border-top:none}
.acc-body{display:none;padding:0 16px 14px}
.acc-row{display:flex;justify-content:space-between;gap:12px;padding:10px 0;border-top:1px solid #f1f5f9;font-weight:950}
.acc-row span{color:var(--muted);font-weight:900}

footer{text-align:center;color:var(--muted);font-size:12px;padding:10px 0 26px}

#adminPanel{display:none;position:fixed;top:0;right:0;width:440px;height:100%;background:#fff;box-shadow:-8px 0 24px rgba(0,0,0,.12);padding:16px;overflow:auto;z-index:1000}
.admin-topbar{position:sticky;top:0;background:#fff;padding:10px 0 14px;z-index:2}
.admin-note{color:var(--muted);font-size:12px;margin-bottom:10px;font-weight:800}
.admin-item{border:1px solid #e5e7eb;border-radius:16px;padding:12px;margin-bottom:10px}
.admin-item input,.admin-item select,.admin-item textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;margin-bottom:8px;font-size:13px;font-weight:900}
.admin-item textarea{min-height:64px;resize:vertical}
.admin-row{display:flex;gap:10px;flex-wrap:wrap}
.admin-row label{display:flex;align-items:center;gap:8px;font-weight:950;font-size:12px;color:#111827;background:#f8fafc;border:1px solid #e5e7eb;padding:8px 10px;border-radius:999px}
.admin-actions{display:flex;gap:10px;margin-top:10px}
.admin-actions button{flex:1;border:none;padding:12px;border-radius:14px;font-weight:950;cursor:pointer}
.admin-actions .danger{background:#ef4444;color:#fff}
.admin-actions .save{background:#111827;color:#fff}
.admin-btn{margin-top:10px;padding:12px !important;border-radius:14px !important;font-size:14px !important}
.hr{height:1px;background:#eef2f7;margin:12px 0}
.hidden{display:none !important}
</style>


<!-- =========================
FILE: script.js
========================= -->
<script>
"use strict";

/**
 * Doylu V1 Premium (3 fichiers)
 * - Toutes les offres <= budget
 * - Tri intelligent + bloc "Meilleure valeur"
 * - Admin persistant (localStorage) + export/import JSON
 */

const ADMIN_PASSWORD = "doyluadmin";
const PAGES = ["home", "promos", "guide", "contact"];
const STORAGE_KEY = "doylu_v1_bundle_v2";

function $(id){ return document.getElementById(id); }
function pad2(n){ return String(n).padStart(2,"0"); }
function nowHHmm(){ const d=new Date(); return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }
function isoNow(){ return new Date().toISOString(); }
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function formatMoney(n){
  try { return new Intl.NumberFormat("fr-FR").format(n); } catch { return String(n); }
}

const SafeStorage = (() => {
  const memory = new Map();
  function hasLocalStorage(){
    try { localStorage.setItem("__t","1"); localStorage.removeItem("__t"); return true; } catch { return false; }
  }
  const enabled = hasLocalStorage();
  return {
    getItem(k){ return enabled ? localStorage.getItem(k) : (memory.get(k) ?? null); },
    setItem(k,v){ enabled ? localStorage.setItem(k,v) : memory.set(k,String(v)); }
  };
})();

let BUNDLE = null;
let OFFERS = [];
let SOURCES = [];

function seedBundle(){
  const t = isoNow();
  return {
    offers: [
      { offer_id:"off_orange_300mb_200", operator:"Orange", name:"Pass USSD 300Mo", price_fcfa:200, type_usage:"data", data_mb:300, minutes:null, validity_days:null, validity_type:"inconnu", ussd_code:"#1234#", activation_path:"#1234# > Je choisis mon pass > 1", status:"active", is_sponsored:false, hidden:false, updated_at:t, created_at:t, last_seen_at:t },
      { offer_id:"off_orange_1_5go_500", operator:"Orange", name:"Pass USSD 1,5Go", price_fcfa:500, type_usage:"data", data_mb:1536, minutes:null, validity_days:null, validity_type:"inconnu", ussd_code:"#1234#", activation_path:"#1234# > Je choisis mon pass > 2", status:"active", is_sponsored:false, hidden:false, updated_at:t, created_at:t, last_seen_at:t },
      { offer_id:"off_orange_3_5go_700_24h", operator:"Orange", name:"Pass USSD 3,5Go (24h)", price_fcfa:700, type_usage:"data", data_mb:3584, minutes:null, validity_days:1, validity_type:"24h", ussd_code:"#1234#", activation_path:"#1234# > (menu data) > 3,5Go 24H", status:"active", is_sponsored:false, hidden:false, updated_at:t, created_at:t, last_seen_at:t },
      { offer_id:"off_orange_5go_1000", operator:"Orange", name:"Pass USSD 5Go", price_fcfa:1000, type_usage:"data", data_mb:5120, minutes:null, validity_days:null, validity_type:"inconnu", ussd_code:"#1234#", activation_path:"#1234# > Je choisis mon pass > 3", status:"active", is_sponsored:false, hidden:false, updated_at:t, created_at:t, last_seen_at:t },
    ],
    sources: [
      { source_id:"src_ussd_menu_1", offer_id:"off_orange_300mb_200", source_type:"website", platform:"ussd", raw_text:"Menu USSD (#1234#) vu par la famille.", received_at:t, is_official:true },
      { source_id:"src_ussd_menu_2", offer_id:"off_orange_1_5go_500", source_type:"website", platform:"ussd", raw_text:"Menu USSD (#1234#) vu par la famille.", received_at:t, is_official:true },
      { source_id:"src_ussd_menu_3", offer_id:"off_orange_3_5go_700_24h", source_type:"website", platform:"ussd", raw_text:"3,5Go valable 24H √† 700F.", received_at:t, is_official:true },
      { source_id:"src_ussd_menu_4", offer_id:"off_orange_5go_1000", source_type:"website", platform:"ussd", raw_text:"Menu USSD (#1234#) vu par la famille.", received_at:t, is_official:true },
    ],
    meta: { last_update: t }
  };
}

function loadBundle(){
  const raw = SafeStorage.getItem(STORAGE_KEY);
  if(!raw){
    BUNDLE = seedBundle();
    persistBundle();
    return;
  }
  try{
    BUNDLE = JSON.parse(raw);
    if(!BUNDLE?.offers || !BUNDLE?.sources) throw new Error("bad");
  }catch{
    BUNDLE = seedBundle();
    persistBundle();
  }
}

function persistBundle(){
  BUNDLE.meta = BUNDLE.meta || {};
  BUNDLE.meta.last_update = isoNow();
  SafeStorage.setItem(STORAGE_KEY, JSON.stringify(BUNDLE));
}

function syncFromBundle(){
  OFFERS = Array.isArray(BUNDLE.offers) ? BUNDLE.offers : [];
  SOURCES = Array.isArray(BUNDLE.sources) ? BUNDLE.sources : [];
}

/* ---------- scoring simple V1 ---------- */
function dataPerFcfa(o){
  if(!o.data_mb || !o.price_fcfa) return 0;
  return Number(o.data_mb) / Number(o.price_fcfa);
}
function minutesPerFcfa(o){
  if(!o.minutes || !o.price_fcfa) return 0;
  return Number(o.minutes) / Number(o.price_fcfa);
}
function offerScore(o, usage){
  const d = dataPerFcfa(o);
  const m = minutesPerFcfa(o);
  const valid = Number(o.validity_days || 0);
  const bonusValid = valid ? Math.min(0.15, valid / 100) : 0;
  const bonusSponsored = o.is_sponsored ? 0.02 : 0;
  const w = usage === "data" ? { wd:1.0, wm:0.15 } : usage === "appels" ? { wd:0.15, wm:1.0 } : { wd:0.65, wm:0.65 };
  return (d * w.wd) + (m * w.wm) + bonusValid + bonusSponsored;
}

function operatorCode(op){
  if(op==="Orange") return "O";
  if(op==="Free") return "F";
  if(op==="Expresso") return "E";
  return "L";
}

function validityLabel(o){
  if(o.validity_type && o.validity_type !== "inconnu") return o.validity_type;
  if(o.validity_days) return `${o.validity_days}j`;
  return "Inconnu";
}

function metaLine(o){
  const parts = [];
  if(o.data_mb) parts.push(`üì± ${(Number(o.data_mb)/1024).toFixed(Number(o.data_mb)%1024===0?0:1)} Go`);
  if(o.minutes) parts.push(`üìû ${o.minutes} min`);
  parts.push(`‚è± ${validityLabel(o)}`);
  return parts.join(" ‚Ä¢ ");
}

function oneBadge(o){
  if(o.is_sponsored) return { cls:"sponsor", label:"Sponsoris√©" };
  // V1: ‚ÄúOfficiel‚Äù si source USSD/website officielle existe
  const hasOfficial = SOURCES.some(s => s.offer_id===o.offer_id && (s.source_type==="website" || (s.source_type==="social" && s.is_official)));
  if(hasOfficial) return { cls:"official", label:"Source officielle" };
  return { cls:"neutral", label:"√Ä confirmer" };
}

/* ---------- routing ---------- */
function currentPageFromHash(){
  const h = (window.location.hash || "#home").replace("#","");
  if(h === "admin") return "home";
  return PAGES.includes(h) ? h : "home";
}

function showPage(page){
  for(const p of PAGES){
    $("page_"+p)?.classList.toggle("hidden-page", p!==page);
    $("nav_"+p)?.classList.toggle("active", p===page);
    $("mnav_"+p)?.classList.toggle("active", p===page);
  }
}

/* ---------- UI behavior ---------- */
let selectedBudget = null;
let selectedUsage = "data";
let selectedValidity = "any";

function toggleLoader(on, text="Recherche en cours‚Ä¶"){
  $("loaderText").textContent = text;
  $("loader").style.display = on ? "flex" : "none";
}

function setLastUpdate(){
  $("lastUpdate").textContent = `aujourd‚Äôhui ${nowHHmm()}`;
}

function showToast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=> t.style.display="none", 2000);
}

async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch{
    return false;
  }
}

function shareWhatsApp(title, price, ussd){
  const msg = `Bon plan Doylu üá∏üá≥\n${title}\nPrix: ${price} FCFA\nCode: ${ussd}\n`;
  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank");
}

function openHowVerify(){
  openModal("Comment on v√©rifie ?", `
    <ul>
      <li>On collecte des offres re√ßues par SMS et vues dans les menus USSD.</li>
      <li>On v√©rifie prix / volume / validit√©, puis on retire les offres expir√©es.</li>
      <li>On affiche la source (SMS, USSD, page officielle) pour inspirer confiance.</li>
    </ul>
  `);
}

function openModal(title, html){
  $("modalTitle").textContent = title || "Info";
  $("modalBody").innerHTML = html || "<p></p>";
  $("modalBackdrop").style.display = "flex";
}
function closeModal(){ $("modalBackdrop").style.display = "none"; }

function passesValidity(o){
  if(selectedValidity==="any") return true;
  const v = Number(selectedValidity);
  const d = Number(o.validity_days || 0);
  if(v===1) return d <= 1 && d !== 0;
  return d >= v;
}

function offerIsDisplayable(o, budget){
  if(o.hidden) return false;
  if(o.status === "expired") return false;
  if(!budget) return false;
  if(Number(o.price_fcfa) > Number(budget)) return false;
  if(!passesValidity(o)) return false;
  return true;
}

function computeResults(){
  const budget = Number(selectedBudget || 0);
  const rows = OFFERS
    .filter(o => o.type_usage === selectedUsage)
    .filter(o => offerIsDisplayable(o, budget))
    .map(o => ({...o, _score: offerScore(o, selectedUsage)}));

  rows.sort((a,b) => b._score - a._score);

  // Neutralit√©: sponsoris√© jamais #1 si une autre offre existe
  if(rows.length > 1 && rows[0].is_sponsored){
    const idx = rows.findIndex(x => !x.is_sponsored);
    if(idx > 0){ const t=rows[0]; rows[0]=rows[idx]; rows[idx]=t; }
  }

  return rows;
}

function renderBestPick(best, count){
  const el = $("bestPick");
  if(!best){ el.style.display="none"; el.innerHTML=""; return; }

  const title = `${best.operator} ‚Äî ${best.name}`;
  el.style.display = "block";
  el.innerHTML = `
    <div class="best-card">
      <div class="best-title">üî• Meilleure valeur aujourd‚Äôhui pour ${formatMoney(selectedBudget)} FCFA</div>
      <div class="best-sub">${escapeHtml(title)} ‚Ä¢ ${escapeHtml(metaLine(best))} ‚Ä¢ <strong>${formatMoney(best.price_fcfa)} FCFA</strong> ‚Äî ${count} offre(s) disponible(s)</div>
    </div>
  `;
}

function renderResults(){
  const resultsEl = $("results");
  const habitEl = $("habitMsg");

  resultsEl.innerHTML = "";
  $("bestPick").style.display = "none";
  habitEl.style.display = "none";

  if(!selectedBudget){
    return;
  }

  const rows = computeResults();

  if(rows.length === 0){
    resultsEl.innerHTML = `
      <div class="offer-card">
        <div class="offer-title">Aucune offre trouv√©e</div>
        <div class="meta-line">Essaie un autre budget ou une autre validit√©.</div>
      </div>
    `;
    habitEl.style.display = "block";
    return;
  }

  renderBestPick(rows[0], rows.length);

  resultsEl.innerHTML = rows.map((o) => {
    const badge = oneBadge(o);
    const title = `${o.operator} ‚Äî ${o.name}`;
    const ussd = o.ussd_code || "USSD indisponible";

    return `
      <div class="offer-card">
        <div class="top-row">
          <div class="operator">
            <div class="op-logo">${escapeHtml(operatorCode(o.operator))}</div>
            <div class="bold">${escapeHtml(o.operator)}</div>
          </div>
          <span class="badge ${badge.cls}">${escapeHtml(badge.label)}</span>
        </div>

        <div class="offer-title">${escapeHtml(title)}</div>
        <div class="price">${formatMoney(o.price_fcfa)} FCFA</div>
        <div class="meta-line">${escapeHtml(metaLine(o))}</div>

        <button class="btn cta" id="reveal_${o.offer_id}" type="button">üëÅÔ∏è Afficher le code</button>
        <div class="ussd-box" id="ussd_${o.offer_id}">${escapeHtml(ussd)}</div>

        <div class="row-actions">
          <button class="btn gray" id="copy_${o.offer_id}" type="button" style="display:none">üìã Copier</button>
          <button class="btn whatsapp" id="share_${o.offer_id}" type="button">üü¢ Partager WhatsApp</button>
        </div>
      </div>
    `;
  }).join("");

  for(const o of rows){
    const title = `${o.operator} ‚Äî ${o.name}`;
    const ussd = o.ussd_code || "USSD indisponible";

    document.getElementById(`reveal_${o.offer_id}`)?.addEventListener("click", () => {
      const box = document.getElementById(`ussd_${o.offer_id}`);
      const copyBtn = document.getElementById(`copy_${o.offer_id}`);
      if(box) box.style.display = "block";
      if(copyBtn) copyBtn.style.display = "inline-flex";
    });

    document.getElementById(`copy_${o.offer_id}`)?.addEventListener("click", async () => {
      const ok = await copyText(ussd);
      if(!ok) return showToast("Copie impossible sur ce navigateur.");
      showToast("Code copi√© ‚úÖ");
    });

    document.getElementById(`share_${o.offer_id}`)?.addEventListener("click", () => shareWhatsApp(title, Number(o.price_fcfa), ussd));
  }

  habitEl.style.display = "block";
}

function renderBudgets(){
  const budgets = [500, 1000, 2000, 3000, 5000];
  $("budgetGrid").innerHTML = budgets.map(b => `<button class="budget-btn" type="button" data-b="${b}">${formatMoney(b)}</button>`).join("");

  document.querySelectorAll(".budget-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const b = Number(btn.dataset.b);
      $("budgetInput").value = String(b);
      setBudget(b, true);
    });
  });
}

function setBudget(b, autoscroll){
  selectedBudget = Number(b);
  document.querySelectorAll(".budget-btn").forEach(x => x.classList.toggle("active", Number(x.dataset.b)===selectedBudget));
  toggleLoader(true, "Recherche en cours‚Ä¶");
  setTimeout(() => {
    toggleLoader(false);
    renderResults();
    if(autoscroll) $("results").scrollIntoView({ behavior:"smooth", block:"start" });
  }, 400);
}

/* ---------- Promos page ---------- */
function renderPromos(){
  const el = $("promoResults");
  const promos = OFFERS
    .filter(o => !o.hidden && o.status !== "expired")
    .filter(o => o.is_sponsored) // V1: promos = sponsoris√© (placeholder) -> tu changeras plus tard avec SMS
    .slice(0, 12);

  if(promos.length === 0){
    el.innerHTML = `
      <div class="offer-card">
        <div class="offer-title">Pas de promos publi√©es pour l‚Äôinstant</div>
        <div class="meta-line">Ajoute des promos via Admin (#admin) quand tu re√ßois des SMS.</div>
      </div>
    `;
    return;
  }

  el.innerHTML = promos.map(o => {
    const badge = oneBadge(o);
    const title = `${o.operator} ‚Äî ${o.name}`;
    const ussd = o.ussd_code || "USSD indisponible";
    return `
      <div class="offer-card">
        <div class="top-row">
          <div class="operator">
            <div class="op-logo">${escapeHtml(operatorCode(o.operator))}</div>
            <div class="bold">${escapeHtml(o.operator)}</div>
          </div>
          <span class="badge ${badge.cls}">${escapeHtml(badge.label)}</span>
        </div>

        <div class="offer-title">${escapeHtml(title)}</div>
        <div class="price">${formatMoney(o.price_fcfa)} FCFA</div>
        <div class="meta-line">${escapeHtml(metaLine(o))}</div>

        <button class="btn cta" id="reveal_${o.offer_id}" type="button">üëÅÔ∏è Afficher le code</button>
        <div class="ussd-box" id="ussd_${o.offer_id}">${escapeHtml(ussd)}</div>

        <div class="row-actions">
          <button class="btn gray" id="copy_${o.offer_id}" type="button" style="display:none">üìã Copier</button>
          <button class="btn whatsapp" id="share_${o.offer_id}" type="button">üü¢ Partager WhatsApp</button>
        </div>
      </div>
    `;
  }).join("");

  for(const o of promos){
    const title = `${o.operator} ‚Äî ${o.name}`;
    const ussd = o.ussd_code || "USSD indisponible";
    document.getElementById(`reveal_${o.offer_id}`)?.addEventListener("click", () => {
      const box = document.getElementById(`ussd_${o.offer_id}`);
      const copyBtn = document.getElementById(`copy_${o.offer_id}`);
      if(box) box.style.display = "block";
      if(copyBtn) copyBtn.style.display = "inline-flex";
    });
    document.getElementById(`copy_${o.offer_id}`)?.addEventListener("click", async () => {
      const ok = await copyText(ussd);
      if(!ok) return showToast("Copie impossible sur ce navigateur.");
      showToast("Code copi√© ‚úÖ");
    });
    document.getElementById(`share_${o.offer_id}`)?.addEventListener("click", () => shareWhatsApp(title, Number(o.price_fcfa), ussd));
  }
}

/* ---------- Popular section (placeholder: hidden if empty) ---------- */
function renderPopular(){
  const section = $("popularSection");
  const list = $("popularList");

  // V1: pas de tracking robuste -> on masque si vide
  section.style.display = "none";
  list.innerHTML = "";
}

/* ---------- Admin (persistant) ---------- */
function adminAuth(){
  return prompt("Mot de passe admin ?") === ADMIN_PASSWORD;
}
function openAdminIfAllowed(){
  if(!adminAuth()){
    window.location.hash = "#home";
    return false;
  }
  $("adminPanel").style.display = "block";
  $("adminPanel").setAttribute("aria-hidden","false");
  renderAdmin();
  return true;
}
function closeAdmin(){
  $("adminPanel").style.display = "none";
  $("adminPanel").setAttribute("aria-hidden","true");
}
function handleAdminRoute(){
  if(window.location.hash === "#admin") openAdminIfAllowed();
  else closeAdmin();
}

function renderAdmin(){
  const list = $("adminList");
  list.innerHTML = OFFERS.map(o => `
    <div class="admin-item">
      <div class="bold">${escapeHtml(o.operator)} ‚Äî ${escapeHtml(o.name)}</div>
      <div class="muted">ID: ${escapeHtml(o.offer_id)}</div>
      <div class="hr"></div>

      <select data-offer="${o.offer_id}" data-field="operator">
        <option ${o.operator==="Orange"?"selected":""}>Orange</option>
        <option ${o.operator==="Free"?"selected":""}>Free</option>
        <option ${o.operator==="Expresso"?"selected":""}>Expresso</option>
        <option ${o.operator==="Lebara"?"selected":""}>Lebara</option>
      </select>

      <input data-offer="${o.offer_id}" data-field="name" value="${escapeHtml(o.name)}" />
      <input data-offer="${o.offer_id}" data-field="price_fcfa" type="number" value="${Number(o.price_fcfa)}" />

      <select data-offer="${o.offer_id}" data-field="type_usage">
        <option value="data" ${o.type_usage==="data"?"selected":""}>data</option>
        <option value="mixte" ${o.type_usage==="mixte"?"selected":""}>mixte</option>
        <option value="appels" ${o.type_usage==="appels"?"selected":""}>appels</option>
      </select>

      <input data-offer="${o.offer_id}" data-field="data_mb" type="number" value="${o.data_mb ?? ""}" placeholder="data_mb" />
      <input data-offer="${o.offer_id}" data-field="minutes" type="number" value="${o.minutes ?? ""}" placeholder="minutes" />
      <input data-offer="${o.offer_id}" data-field="validity_days" type="number" value="${o.validity_days ?? ""}" placeholder="validity_days (ex: 1, 7, 30)" />
      <input data-offer="${o.offer_id}" data-field="validity_type" value="${escapeHtml(o.validity_type ?? "inconnu")}" placeholder="validity_type (24h/7j/30j/mois/inconnu)" />
      <input data-offer="${o.offer_id}" data-field="ussd_code" value="${escapeHtml(o.ussd_code ?? "")}" placeholder="ussd_code" />
      <input data-offer="${o.offer_id}" data-field="activation_path" value="${escapeHtml(o.activation_path ?? "")}" placeholder="activation_path" />

      <div class="admin-row">
        <label><input data-offer="${o.offer_id}" data-field="hidden" type="checkbox" ${o.hidden ? "checked":""}/> hidden</label>
        <label><input data-offer="${o.offer_id}" data-field="is_sponsored" type="checkbox" ${o.is_sponsored ? "checked":""}/> sponsoris√©</label>
      </div>

      <div class="admin-actions">
        <button class="save" type="button" data-action="save" data-offer="${o.offer_id}">Sauver</button>
        <button class="danger" type="button" data-action="delete" data-offer="${o.offer_id}">Supprimer</button>
      </div>
    </div>
  `).join("");

  list.querySelectorAll("input,select,textarea").forEach(el => {
    el.addEventListener("change", () => {
      const offerId = el.getAttribute("data-offer");
      const field = el.getAttribute("data-field");
      const offer = OFFERS.find(x => x.offer_id === offerId);
      if(!offer) return;

      let v;
      if(el.type === "checkbox") v = el.checked;
      else v = el.value;

      if(["price_fcfa","data_mb","minutes","validity_days"].includes(field)) v = v === "" ? null : Number(v);

      offer[field] = v;
      offer.updated_at = isoNow();

      // Persist immediately so home sees it
      BUNDLE.offers = OFFERS;
      BUNDLE.sources = SOURCES;
      persistBundle();

      // Re-render home instantly
      if(selectedBudget) renderResults();
      renderPromos();
    });
  });

  list.querySelectorAll("button[data-action]").forEach(btn => {
    btn.addEventListener("click", () => {
      const action = btn.getAttribute("data-action");
      const offerId = btn.getAttribute("data-offer");
      if(!offerId) return;

      if(action === "delete"){
        if(!confirm("Supprimer cette offre ?")) return;
        OFFERS = OFFERS.filter(o => o.offer_id !== offerId);
        SOURCES = SOURCES.filter(s => s.offer_id !== offerId);
        BUNDLE.offers = OFFERS;
        BUNDLE.sources = SOURCES;
        persistBundle();
        renderAdmin();
        renderPromos();
        if(selectedBudget) renderResults();
      }
    });
  });
}

function openPasteImportModal(){
  openModal("Coller JSON", `
    <p class="muted">Colle un JSON au format <strong>{ "offers": [...], "sources": [...] }</strong></p>
    <textarea id="pasteJson" style="width:100%;min-height:220px;padding:12px;border-radius:14px;border:1px solid #e5e7eb;font-weight:900;font-size:13px"></textarea>
    <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
      <button class="btn cta" type="button" id="pasteImportConfirm">Importer</button>
      <button class="btn gray" type="button" id="pasteImportCancel">Annuler</button>
    </div>
  `);

  document.getElementById("pasteImportCancel")?.addEventListener("click", closeModal);
  document.getElementById("pasteImportConfirm")?.addEventListener("click", () => {
    const raw = String(document.getElementById("pasteJson")?.value || "").trim();
    if(!raw) return alert("Colle le JSON d'abord.");
    try{
      const b = JSON.parse(raw);
      if(!Array.isArray(b.offers) || !Array.isArray(b.sources)) return alert("Format invalide.");
      BUNDLE.offers = b.offers;
      BUNDLE.sources = b.sources;
      persistBundle();
      syncFromBundle();
      renderAdmin();
      renderPromos();
      if(selectedBudget) renderResults();
      closeModal();
      showToast("Import OK ‚úÖ");
    }catch{
      alert("JSON illisible.");
    }
  });
}

function adminExport(){
  const out = { offers: OFFERS, sources: SOURCES, exported_at: isoNow() };
  const blob = new Blob([JSON.stringify(out, null, 2)], { type:"application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `doylu_export_${Date.now()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  showToast("Export JSON ‚úÖ");
}

function adminImportFile(file){
  const r = new FileReader();
  r.onload = () => {
    try{
      const b = JSON.parse(String(r.result || "{}"));
      if(!Array.isArray(b.offers) || !Array.isArray(b.sources)) return alert("Format invalide.");
      BUNDLE.offers = b.offers;
      BUNDLE.sources = b.sources;
      persistBundle();
      syncFromBundle();
      renderAdmin();
      renderPromos();
      if(selectedBudget) renderResults();
      showToast("Import fichier OK ‚úÖ");
    }catch{
      alert("Fichier JSON invalide.");
    }
  };
  r.readAsText(file);
}

/* ---------- events ---------- */
function toggleMobileMenu(forceClose=false){
  const menu = $("mobileMenu");
  if(forceClose) return menu.classList.add("hidden");
  menu.classList.toggle("hidden");
}

function bindEvents(){
  $("brandBtn").addEventListener("click", () => window.location.hash = "#home");
  $("brandBtn").addEventListener("keydown", (e) => { if(e.key==="Enter") window.location.hash="#home"; });

  $("hamburgerBtn").addEventListener("click", () => toggleMobileMenu());
  ["home","promos","guide","contact"].forEach(p => $("mnav_"+p)?.addEventListener("click", () => toggleMobileMenu(true)));

  $("howVerifyLink").addEventListener("click", (e) => { e.preventDefault(); openHowVerify(); });
  $("howVerifyBtn2")?.addEventListener("click", openHowVerify);

  $("modalBackdrop").addEventListener("click", (e) => { if(e.target?.id==="modalBackdrop") closeModal(); });
  $("modalCloseBtn").addEventListener("click", closeModal);

  $("waOptIn").addEventListener("click", () => {
    window.open(`https://wa.me/?text=${encodeURIComponent("Salut ! Je veux recevoir les bons plans Doylu sur WhatsApp.")}`, "_blank");
  });

  $("waSupportBtn")?.addEventListener("click", () => {
    window.open(`https://wa.me/?text=${encodeURIComponent("Salut Doylu, j‚Äôai une question / un signalement.")}`, "_blank");
  });

  $("reportBtn")?.addEventListener("click", () => openModal("Signaler une offre", `<p class="muted">V1 : envoie ton signalement sur WhatsApp Business.</p>`));
  $("sendPromoBtn")?.addEventListener("click", () => openModal("Envoyer une promo SMS", `<p class="muted">V1 : copie-colle le SMS promo dans WhatsApp Business.</p>`));
  $("backHomeBtn")?.addEventListener("click", () => { window.location.hash="#home"; setTimeout(()=>window.scrollTo({top:0,behavior:"smooth"}), 50); });

  document.querySelectorAll("[data-u]").forEach(btn => btn.addEventListener("click", () => {
    selectedUsage = btn.getAttribute("data-u");
    document.querySelectorAll("[data-u]").forEach(x => x.classList.remove("active"));
    btn.classList.add("active");
    if(selectedBudget) renderResults();
  }));

  document.querySelectorAll("[data-v]").forEach(btn => btn.addEventListener("click", () => {
    selectedValidity = btn.getAttribute("data-v");
    document.querySelectorAll("[data-v]").forEach(x => x.classList.remove("active"));
    btn.classList.add("active");
    if(selectedBudget) renderResults();
  }));

  $("findBtn").addEventListener("click", () => {
    const b = Number($("budgetInput").value || 0);
    if(!b) return;
    setBudget(b, true);
  });

  $("budgetInput").addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      const b = Number($("budgetInput").value || 0);
      if(!b) return;
      setBudget(b, true);
    }
  });

  document.querySelectorAll(".acc-head").forEach(h => h.addEventListener("click", () => {
    const body = h.nextElementSibling;
    if(!body) return;
    body.style.display = body.style.display === "block" ? "none" : "block";
  }));

  // Admin buttons
  $("adminRecomputeBtn").addEventListener("click", () => {
    persistBundle();
    syncFromBundle();
    renderAdmin();
    renderPromos();
    if(selectedBudget) renderResults();
    showToast("Recalcul OK ‚úÖ");
  });
  $("adminExportBtn").addEventListener("click", adminExport);
  $("adminImportBtn").addEventListener("click", () => $("adminImportFile").click());
  $("adminPasteBtn").addEventListener("click", openPasteImportModal);
  $("adminImportFile").addEventListener("change", (e) => { const f=e.target.files?.[0]; if(f) adminImportFile(f); });

  // Add offer/source (simple V1)
  $("adminAddOfferBtn").addEventListener("click", () => {
    openModal("Ajouter une offre", `
      <div class="muted">V1 rapide: tu ajoutes une offre puis tu compl√®tes dans la liste admin.</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn cta" type="button" id="createData">Cr√©er offre Data</button>
        <button class="btn cta" type="button" id="createAppels">Cr√©er offre Appels</button>
        <button class="btn cta" type="button" id="createMixte">Cr√©er offre Mixte</button>
      </div>
    `);

    const create = (type) => {
      const t = isoNow();
      const id = `off_${Date.now()}_${Math.floor(Math.random()*1e6)}`;
      OFFERS.unshift({
        offer_id:id, operator:"Orange", name:"Nouvelle offre", price_fcfa:0,
        type_usage:type, data_mb:null, minutes:null,
        validity_days:null, validity_type:"inconnu",
        ussd_code:"", activation_path:"", status:"active",
        is_sponsored:false, hidden:false, updated_at:t, created_at:t, last_seen_at:t
      });
      BUNDLE.offers = OFFERS;
      BUNDLE.sources = SOURCES;
      persistBundle();
      closeModal();
      renderAdmin();
      if(selectedBudget) renderResults();
    };

    document.getElementById("createData")?.addEventListener("click", () => create("data"));
    document.getElementById("createAppels")?.addEventListener("click", () => create("appels"));
    document.getElementById("createMixte")?.addEventListener("click", () => create("mixte"));
  });

  $("adminAddSourceBtn").addEventListener("click", () => {
    openModal("Ajouter une source", `
      <div class="muted">V1 rapide: ajoute une preuve li√©e √† une offre (SMS/USSD).</div>
      <div style="margin-top:10px" class="muted">Utilise plut√¥t ‚ÄúColler JSON‚Äù si tu as beaucoup de donn√©es.</div>
    `);
  });
}

window.addEventListener("hashchange", () => {
  showPage(currentPageFromHash());
  if(currentPageFromHash()==="promos") renderPromos();
  handleAdminRoute();
});

function boot(){
  loadBundle();
  syncFromBundle();

  bindEvents();
  renderBudgets();
  renderPopular();
  renderPromos();

  setLastUpdate();
  setInterval(setLastUpdate, 30_000);

  showPage(currentPageFromHash());
  handleAdminRoute();
}

boot();
</script>
